---
title: "Impact of Severe Weather Events Across the United States between 1950 and 2011"
author: "Lawrence C. Chen"
date: "Friday, May 15, 2015"
output: 
  html_document:
    keep_md: true
---

## Synopsis

Research questions:

* Across the United States, which types of events (as indicated in the EVTYPE
variable) are most harmful with respect to population health?

* Across the United States, which types of events have the greatest economic
consequences?

## Loading and preprocessing the raw data

```{r download and sample data}
url <- 'https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2'
filename <- 'repdata-data-StormData.csv.bz2'

#check if the data file is available
if (!file.exists(filename)) {
    download.file(url = url, destfile = filename)
}

sample <- read.csv(filename, nrows = 100)

head(sample)

colClasses <- vapply(sample, class, 'character')
ch <- grep('(logical|integer|factor)', colClasses)
colClasses[ch] <- 'character'

as.data.frame(colClasses)
```


```{r data, cache=TRUE}
library(data.table)

dtl <- as.data.table(read.csv(filename, na.strings = '', colClasses = colClasses))

dim(dtl)

head(dtl)
```

Columns crucial to the analsyis are:

* STATE (2-letter state designation, including the US Territories)

* BGN_DATE (date which the event occured)

* EVTYPE (type of event)

* FATALITIES (no. of human fatalities)

* INJURIES (no. of human injuries)

* PROPDMG (dollar amount of property damage)

* PROPDMGEXP (magnitude of amount in thousand (K), million (M), or billion (B))

* CROPDMG (dollar amount of crop damange)

* CROPDMGEXP (magnitude of amount in thousand (K), million (M), or billion (B))

###Data cleansing
```{r colnames, results='hide'}
library(data.table)

setnames(dtl, c(1, 35), c('STATE_FIPS', 'LONGITUDE_E'))

dtl[, ':='(STATE_FIPS =as.integer(STATE_FIPS),
           BGN_DATE   =as.IDate(BGN_DATE, '%m/%d/%Y'),
           EVTYPE     =tolower(EVTYPE),           
           REFNUM     =as.integer(REFNUM))]

```

Of the `r dim(dtl)[1]` rows of data, `r dtl[PROPDMG > 0 | CROPDMG > 0 , sum((!grepl('[KMBkmb]', PROPDMGEXP) | !grepl('[KBMkbm]', CROPDMGEXP)))]` of which do not have the proper magnitude
desingations.  In those instances, thousand (K) are assumed.

```{r damage tally, results='hide'}
dmgAmt <- function(value, magnitude = 'K') {
    #returns dollar value in mulitple of thousands.
    #If magnitude is not one of 'K', 'M' or 'B', assume 'K'.

    #assumes value and magnitude are both equal length

    val <- numeric(length(value))

    for (i in 1:length(value)) {
        mag <- toupper(magnitude[i])

        if (!grepl('[MB]', mag) | is.na(mag)) {
            val[i] <- value[i]
        } else if (mag == 'M') {
            val[i] <- value[i] * 1e3
        } else if (mag == 'B') {
            val[i] <- value[i] * 1e6
        }
    }

    val
}

dtl[PROPDMG > 0, PropDmg:=dmgAmt(PROPDMG, PROPDMGEXP)]

dtl[CROPDMG > 0, CropDmg:=dmgAmt(CROPDMG, CROPDMGEXP)]
```

```{r damage tally2}
dtl[, .(PropDmg=sum(PropDmg, na.rm = T),
        CropDmg=sum(CropDmg, na.rm = T),
        Injuries=sum(INJURIES, na.rm = T),
        Fatalitites=sum(FATALITIES, na.rm = T)),
    by = STATE]
```



too many events; how about categories of events?

dimensionality reduction; feature extraction
```{r event types}
library(data.table)

sort(dtl[, unique(EVTYPE)])


#HUNDERSTORM WIND
dtl[grepl('summary', EVTYPE) & grepl('[Tt]hunderstorm.*[Ww]ind', REMARKS), EVTYPE:='Thunderstorm Wind']

#HAIL
dtl[grepl('summary', EVTYPE) & grepl('[Hh]ail', REMARKS), EVTYPE:='Hail']

#FLASH FLOOD
dtl[grepl('summary', EVTYPE) & grepl('[Ff]lash flood', REMARKS), EVTYPE:='Flood']

#LIGHTNING
dtl[grepl('summary', EVTYPE) & grepl('[Ll]ightning', REMARKS), EVTYPE:='Lightning']

#BLIZZARD
dtl[grepl('SUMMARY', EVTYPE) & grepl('[Bb]lizzard', REMARKS), EVTYPE:='Blizzard']

#VOLCANIC ASH
dtl[grepl('^[vo]', EVTYPE), EVTYPE:='Volcanic Ash']


```



### Assignment Instructions 

The basic goal of this assignment is to explore the NOAA Storm Database and answer some basic questions about severe weather events. You must use the database to answer the questions below and show the code for your entire analysis. Your analysis can consist of tables, figures, or other summaries. You may use any R package you want to support your analysis.

Questions

Your data analysis must address the following questions:

* Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

* Across the United States, which types of events have the greatest economic consequences?

Consider writing your report as if it were to be read by a government or municipal manager who might be responsible for preparing for severe weather events and will need to prioritize resources for different types of events. However, there is no need to make any specific recommendations in your report.


###Requirements

####Document Layout

Language: Your document should be written in English.

Title: Your document should have a title that briefly summarizes your data analysis

Synopsis: Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.

There should be a section titled Data Processing which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

There should be a section titled Results in which your results are presented.

You may have other sections in your analysis, but Data Processing and Results are required.

The analysis document must have at least one figure containing a plot.

Your analysis must have no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.

You must show all your code for the work in your analysis document. This may make the document a bit verbose, but that is okay. In general, you should ensure that echo = TRUE for every code chunk (this is the default setting in knitr).

####Publishing Your Analysis

For this assignment you will need to publish your analysis on RPubs.com. If you do not already have an account, then you will have to create a new account. After you have completed writing your analysis in RStudio, you can publish it to RPubs by doing the following:

In RStudio, make sure your R Markdown document (.Rmd) document is loaded in the editor

Click the Knit HTML button in the doc toolbar to preview your document.

In the preview window, click the Publish button.

Once your document is published to RPubs, you should get a unique URL to that document. Make a note of this URL as you will need it to submit your assignment.

NOTE: If you are having trouble connecting with RPubs due to proxy-related or other issues, you can upload your final analysis document file as a PDF to Coursera instead.
